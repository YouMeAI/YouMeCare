require('dotenv').config(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

const { Telegraf, Markup } = require('telegraf'); // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è Telegram
const fs = require('fs');                        // –î–ª—è —á—Ç–µ–Ω–∏—è JSON-—Å—Ü–µ–Ω–∞—Ä–∏—è
const path = require('path');                    // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏
const { OpenAI } = require('openai');            // –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ OpenAI SDK

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI —Å API-–∫–ª—é—á–æ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API-–∫–ª—é—á–∞ –∏–∑ .env
});

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞—à —Ç–æ–∫–µ–Ω Telegram
 */
const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–¢–û–ö–ï–ù';

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram-–±–æ—Ç–∞
 */
const bot = new Telegraf(TELEGRAM_BOT_TOKEN);

/**
 * –•—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
let userSessions = {};

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É
 */
async function getAIResponse(userMessage) {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å GPT-4o-mini
      messages: [
        { role: 'system', content: 'You are a helpful assistant trained to help with emotional and psychological issues.' },
        { role: 'user', content: userMessage },
      ],
    });

    const gptAnswer = completion.choices[0].message.content;
    return gptAnswer;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI:', error);
    return '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
  }
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
 * - –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ "–î–∏–∞–ª–æ–≥" –∏ "–î–Ω–µ–≤–Ω–∏–∫" —Å —ç–º–æ–¥–∑–∏
 */
bot.start((ctx) => {
  const userId = ctx.from.id;
  userSessions[userId] = {
    step: 1,
    status: 'basic', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ
  };

  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Å–º–∞–π–ª–∏–∫–∞–º–∏, –∫–Ω–æ–ø–∫–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
  ctx.reply(
    `–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å?`,
    Markup.inlineKeyboard([
      [Markup.button.callback('üí¨ –î–∏–∞–ª–æ–≥', 'start_dialog'), Markup.button.callback('üìì –î–Ω–µ–≤–Ω–∏–∫', 'start_diary')]
    ])
  );
});

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–î–∏–∞–ª–æ–≥" –∏ "–î–Ω–µ–≤–Ω–∏–∫"
 */
bot.on('callback_query', async (ctx) => {
  const userId = ctx.from.id;
  const callbackData = ctx.callbackQuery.data;

  // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callbackQuery, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ç–∞–π–º–∞—É—Ç–∞
  await ctx.answerCbQuery();

  if (callbackData === 'start_dialog') {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–î–∏–∞–ª–æ–≥", –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—â–µ–Ω–∏–µ —Å AI
    const message = '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–≥–æ–¥–Ω—è?';

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (–≥–æ—Ç–æ–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç)
    ctx.replyWithChatAction('typing'); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é —Å –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º
    ctx.reply(message);

    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —à–∞–≥ –¥–∏–∞–ª–æ–≥–∞
    userSessions[userId].step = 'dialog';
  }

  if (callbackData === 'start_diary') {
    // –ü–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
    ctx.reply('–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –û–∂–∏–¥–∞–π—Ç–µ.');
  }
});

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º)
 */
bot.on('text', async (ctx) => {
  const userId = ctx.from.id;
  const userText = ctx.message.text.trim();

  if (userSessions[userId].step === 'dialog') {
    // –ï—Å–ª–∏ –º—ã –≤ –¥–∏–∞–ª–æ–≥–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
    ctx.replyWithChatAction('typing'); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º

    const response = await getAIResponse(userText);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
    ctx.reply(response);

    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–ü–æ–º–æ–≥–ª–æ" –∏–ª–∏ "–ù–µ –ø–æ–º–æ–≥–ª–æ"
    ctx.reply(
      '–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–∏? –í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∏–∑ –æ–ø—Ü–∏–π:',
      Markup.inlineKeyboard([
        [Markup.button.callback('‚úÖ –ü–æ–º–æ–≥–ª–æ', 'helped'), Markup.button.callback('‚ùå –ù–µ –ø–æ–º–æ–≥–ª–æ', 'not_helped')]
      ])
    );
  }
});

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ "–ü–æ–º–æ–≥–ª–æ" –∏–ª–∏ "–ù–µ –ø–æ–º–æ–≥–ª–æ"
 */
bot.on('callback_query', async (ctx) => {
  const userId = ctx.from.id;
  const callbackData = ctx.callbackQuery.data;

  // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callbackQuery, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ç–∞–π–º–∞—É—Ç–∞
  await ctx.answerCbQuery();

  if (callbackData === 'helped') {
    // –ï—Å–ª–∏ –ø–æ–º–æ–≥–ª–æ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ñ—Ñ–µ—Ä
    ctx.reply(
      '–ü–æ—Å–∫–æ–ª—å–∫—É —Å–æ–≤–µ—Ç—ã –ø–æ–º–æ–≥–ª–∏, —è —Ö–æ—á—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–±–µ –ø–æ–¥–ø–∏—Å–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∏ –¥–æ—Å—Ç—É–ø –∫ –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑—É, –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç–≤–æ–µ–π –ø—Ä–æ–±–ª–µ–º—ã. –ó–∞ –ø–æ–¥–ø–∏—Å–∫—É —Ç—ã —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –∫ "–î–Ω–µ–≤–Ω–∏–∫—É —á—É–≤—Å—Ç–≤", –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–≤–æ–∏ —ç–º–æ—Ü–∏–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å.\n\n–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ?',
      Markup.inlineKeyboard([
        [Markup.button.callback('üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 'subscribe')]
      ])
    );
  } else if (callbackData === 'not_helped') {
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–æ–≤—ã–π —Å–æ–≤–µ—Ç –∏–ª–∏ —Ç–µ—Ö–Ω–∏–∫—É
    ctx.reply('–ü–æ–ø—Ä–æ–±—É–π –≥–ª—É–±–æ–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –∏ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —Å–≤–æ–µ–º –¥—ã—Ö–∞–Ω–∏–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.');
    userSessions[userId].step = 'dialog';
  }

  if (callbackData === 'subscribe') {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
    ctx.reply('–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É. –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∏ –¥–æ—Å—Ç—É–ø –∫ –≥–ª—É–±–æ–∫–æ–º—É –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑—É.');
  }
});

/**
 * –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
 */
bot.launch().then(() => {
  console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!');
}).catch((err) => {
  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:', err);
});